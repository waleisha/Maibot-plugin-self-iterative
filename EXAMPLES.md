# MaiBot自我迭代框架插件 - 使用示例

本文档提供详细的使用示例，帮助你快速上手自我迭代框架。

## 目录

1. [基础示例](#基础示例)
2. [代码优化示例](#代码优化示例)
3. [Bug修复示例](#bug修复示例)
4. [功能添加示例](#功能添加示例)
5. [批量修改示例](#批量修改示例)

---

## 基础示例

### 示例1: 查看迭代状态

```
/status
```

**预期输出:**
```
📋 迭代状态

🔄 当前状态: IDLE
💡 可用命令:
• /iterate [目标] - 发起新的迭代
• /diff - 查看差异
• /approve - 审核通过
• /reject - 打回修改
• /rollback [时间戳] - 回滚版本
```

### 示例2: 发起迭代请求

```
/iterate 优化日志输出格式
```

**预期输出:**
```
🚀 自我迭代流程已启动

🆔 迭代ID: 20240115_143022
👤 请求者: 123456789
🕐 时间: 2024-01-15 14:30:22

🎯 目标: 优化日志输出格式

📋 可用工具:
• read_file - 读取源代码文件
• write_file - 将修改写入影子工作区
• execute_terminal - 执行安全命令

💡 提示: 你可以直接告诉我你想优化什么，我会使用工具来完成迭代。
```

---

## 代码优化示例

### 示例3: 优化插件日志输出

**场景**: 你想让某个插件的日志输出更加详细

**操作步骤**:

1. **发起迭代**
   ```
   麦麦，帮我优化一下 hello_world_plugin 的日志输出，让它更详细一些
   ```

2. **MaiBot会自动执行**:
   - 使用 `read_file` 读取 `plugins/hello_world_plugin/plugin.py`
   - 分析代码结构
   - 使用 `write_file` 将优化后的代码写入影子工作区

3. **查看差异**
   ```
   /diff
   ```

4. **审核修改**
   ```
   /approve
   ```

### 示例4: 添加类型注解

**场景**: 为插件代码添加Python类型注解

```
/iterate 为 plugins/my_plugin/plugin.py 添加类型注解
```

**MaiBot会**:
1. 读取目标文件
2. 分析函数签名
3. 添加适当的类型注解
4. 写入影子工作区
5. 等待审核

---

## Bug修复示例

### 示例5: 修复空指针异常

**场景**: 某个插件在特定情况下会报错

```
麦麦，修复一下 my_plugin 中当 message 为 None 时的报错
```

**MaiBot会**:
1. 读取插件源码
2. 定位可能的空指针问题
3. 添加空值检查
4. 生成差异报告

**差异示例**:
```diff
- def process_message(message):
-     return message.content.upper()
+ def process_message(message):
+     if message is None:
+         return ""
+     return message.content.upper()
```

### 示例6: 修复缩进错误

```
麦麦，检查一下 my_plugin/plugin.py 有没有语法错误
```

---

## 功能添加示例

### 示例7: 添加新命令

**场景**: 为现有插件添加一个新命令

```
麦麦，给 hello_world_plugin 添加一个 /hello2 命令，回复"你好呀"
```

**MaiBot会**:
1. 读取现有插件代码
2. 分析命令结构
3. 添加新命令类
4. 注册到插件

### 示例8: 添加新工具

```
麦麦，给插件添加一个获取系统信息的工具
```

---

## 批量修改示例

### 示例9: 统一代码风格

```
麦麦，统一 plugins 目录下所有插件的代码风格
```

**注意事项**:
- 批量修改会产生大量变更
- 建议分批审核
- 先在测试环境验证

### 示例10: 更新导入语句

```
麦麦，将所有插件中的 from src.common import logger 改为 from src.common.logger import get_logger
```

---

## 高级用法

### 使用终端命令

```
麦麦，帮我执行 pip list 查看已安装的包
```

MaiBot会使用 `execute_terminal` 工具执行命令并返回结果。

### 回滚操作

**查看可用备份**:
```
/rollback
```

**回滚到指定版本**:
```
/rollback 20240115_143022
```

---

## 安全最佳实践

### 1. 审核前检查清单

在 `/approve` 之前，请确认:
- [ ] 理解修改的内容
- [ ] 检查差异报告
- [ ] 确认没有敏感信息泄露
- [ ] 在测试环境验证（如果可能）

### 2. 配置白名单

根据实际需求配置白名单:

```toml
[security]
# 只允许修改特定插件
allowed_write_paths = [
    "plugins/my_custom_plugin",
]

# 只允许读取必要的目录
allowed_read_paths = [
    "plugins/my_custom_plugin",
    "src/common",
]
```

### 3. 定期清理备份

备份文件会占用磁盘空间，建议:
- 设置合理的 `max_backups` 值
- 定期手动清理旧备份

---

## 故障排查

### 问题1: 修改后插件无法加载

**解决方案**:
1. 使用 `/rollback` 回滚
2. 检查语法错误
3. 查看MaiBot日志

### 问题2: 工具调用失败

**可能原因**:
- 路径不在白名单内
- 文件不存在
- 权限不足

**解决方案**:
1. 检查 `config.toml` 中的白名单配置
2. 确认文件存在
3. 检查文件权限

### 问题3: 审核超时

**解决方案**:
在 `config.toml` 中增加超时时间:
```toml
[iteration]
approval_timeout = 600  # 增加到10分钟
```

---

## 提示与技巧

### 1. 使用自然语言

你可以直接用自然语言描述需求，MaiBot会理解并执行:

```
麦麦，把那个插件的日志改详细点
```

### 2. 指定具体文件

对于复杂修改，建议指定具体文件:

```
麦麦，优化 plugins/my_plugin/core.py 中的 handle_message 函数
```

### 3. 分步迭代

复杂修改建议分步进行:

```
# 第一步：读取并分析
麦麦，读取 plugins/my_plugin/plugin.py 并告诉我它的结构

# 第二步：提出修改方案
麦麦，我想添加一个新功能，你觉得怎么改比较好？

# 第三步：执行修改
麦麦，按照刚才的方案执行修改
```

### 4. 利用差异报告

`/diff` 命令生成的报告非常详细，可以用来:
- 理解修改内容
- 发现潜在问题
- 学习代码变更

---

## 更多示例

欢迎提交你的使用示例，帮助完善本文档！
