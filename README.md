# MaiBot自我迭代框架插件

一个让MaiBot能够自我迭代、自我优化的框架插件。支持代码读取、修改、校验、差异对比和部署，包含完整的安全审核机制。

## 功能特性

### 核心功能
- **代码读取工具** (`read_file`) - 安全读取白名单内的源代码
- **代码写入工具** (`write_file`) - 将修改写入影子工作区
- **终端执行工具** (`execute_terminal`) - 执行安全的系统命令
- **AST语法校验** - 自动检查代码语法错误
- **差异生成器** - 生成Git风格的diff报告
- **人工审核机制** - 管理员确认后才应用修改
- **自动备份系统** - 修改前自动备份原文件
- **一键回滚功能** - 支持快速回滚到历史版本
- **迭代状态追踪** - 实时显示当前迭代进度

### 安全特性
- **目录白名单** - 严格控制可读取/修改的路径
- **文件黑名单** - 禁止访问敏感文件(.env, token, password等)
- **命令白名单** - 只允许执行安全的终端命令
- **影子工作区** - 所有修改先写入隔离区域
- **人工审核** - 关键操作需要管理员确认
- **自动备份** - 修改前自动创建备份

## 安装

1. 将插件文件夹复制到MaiBot的plugins目录:
```bash
cp -r maibot_plugin_self_iterative /path/to/MaiBot/plugins/
```

2. 编辑配置文件 `config.toml`，设置管理员QQ号:
```toml
[security]
admin_qqs = [123456789]  # 替换为你的QQ号
```

3. 重启MaiBot加载插件

## 使用方法

### 1. 发起迭代请求

使用 `/iterate` 命令发起自我迭代:
```
/iterate 优化message_router.py的日志输出
```

或者直接告诉MaiBot:
```
麦麦，帮我优化一下message_router.py的日志输出
```

### 2. 大模型执行迭代

MaiBot会使用以下工具完成迭代:
- `read_file` - 读取目标文件
- `write_file` - 将修改写入影子工作区
- `execute_terminal` - 执行必要的命令

### 3. 查看差异

使用 `/diff` 命令查看修改内容:
```
/diff
```

### 4. 审核修改

管理员使用以下命令审核:
- `/approve` 或 `/允许` 或 `/确认` - 应用修改
- `/reject` 或 `/拒绝` 或 `/打回` - 拒绝修改

### 5. 查看状态

使用 `/status` 命令查看当前迭代状态:
```
/status
```

### 6. 回滚版本

使用 `/rollback` 命令回滚到之前的版本:
```
/rollback                    # 查看可用备份列表
/rollback 20240115_143022   # 回滚到指定版本
```

## 命令列表

| 命令 | 别名 | 描述 |
|------|------|------|
| `/iterate [目标]` | - | 触发自我迭代流程 |
| `/approve` | `/允许`, `/确认`, `/同意` | 审核通过并应用修改 |
| `/reject` | `/拒绝`, `/打回`, `/不同意` | 打回修改请求 |
| `/diff` | - | 查看当前修改的差异 |
| `/status` | - | 查看迭代状态 |
| `/rollback [时间戳]` | - | 回滚到指定版本 |

## 配置说明

### 安全设置 `[security]`

```toml
[security]
# 超级管理员QQ号列表
admin_qqs = [123456789]

# 允许读取的目录白名单
allowed_read_paths = ["src/plugins", "plugins"]

# 允许修改的目录白名单（更加严格）
allowed_write_paths = ["plugins"]

# 禁止访问的文件模式（正则表达式）
forbidden_patterns = [".*\\.env.*", ".*token.*", ".*password.*"]

# 允许的终端命令
allowed_commands = ["pip", "python", "git"]

# 禁止的终端命令
forbidden_commands = ["rm -rf /"]
```

### 迭代设置 `[iteration]`

```toml
[iteration]
# 影子工作区路径
shadow_workspace_path = "storage/.shadow"

# 备份存储路径
backup_path = "storage/.backups"

# 最大备份数量
max_backups = 50

# 是否启用自动语法检查
enable_syntax_check = true

# 审核超时时间（秒）
approval_timeout = 300
```

## 工作原理

```
┌─────────────────────────────────────────────────────────────────┐
│                        自我迭代流程                              │
└─────────────────────────────────────────────────────────────────┘

  用户请求迭代
       │
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   触发迭代    │────▶│  LLM分析     │────▶│  读取源码    │
│  /iterate    │     │              │     │  read_file   │
└──────────────┘     └──────────────┘     └──────────────┘
                                                   │
       ┌───────────────────────────────────────────┘
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  写入影子区   │────▶│  语法校验    │────▶│  生成差异    │
│  write_file  │     │  verifier    │     │  differ      │
└──────────────┘     └──────────────┘     └──────────────┘
                                                   │
       ┌───────────────────────────────────────────┘
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  等待审核    │────▶│  管理员决策   │────▶│  应用/打回   │
│  Pending     │     │  approve/    │     │  patcher     │
│              │     │  reject      │     │              │
└──────────────┘     └──────────────┘     └──────────────┘
                                                   │
                               ┌───────────────────┘
                               ▼
                        ┌──────────────┐
                        │  备份 & 部署  │
                        │  backup      │
                        │  deploy      │
                        └──────────────┘
```

## 目录结构

```
maibot_plugin_self_iterative/
├── _manifest.json          # 插件清单文件
├── config.toml             # 插件配置文件
├── plugin.py               # 插件主入口
├── README.md               # 说明文档
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── workspace.py        # 影子工作区管理器
│   ├── verifier.py         # 静态校验器
│   ├── differ.py           # 差异生成器
│   └── patcher.py          # 缝合与部署器
├── tools/                  # 工具模块
│   └── __init__.py
├── handlers/               # 处理器模块
│   └── __init__.py
└── storage/                # 存储目录
    ├── .shadow/            # 影子工作区
    └── .backups/           # 备份存储
```

## 注意事项

1. **安全第一**: 请务必设置管理员QQ号，防止未授权操作
2. **备份重要**: 修改前会自动备份，但建议定期手动备份重要文件
3. **测试环境**: 建议在测试环境先验证修改再应用到生产环境
4. **语法检查**: Python代码会自动进行AST语法检查，但无法保证逻辑正确性
5. **重启需求**: 部分修改可能需要重启MaiBot才能生效

## 故障排除

### 插件无法加载
- 检查MaiBot版本是否满足最低要求 (>= 0.8.0)
- 检查配置文件格式是否正确

### 无法读取/写入文件
- 检查 `allowed_read_paths` 和 `allowed_write_paths` 配置
- 检查文件路径是否在白名单内
- 检查文件是否存在

### 审核命令无效
- 确认你的QQ号在 `admin_qqs` 列表中
- 检查当前是否有等待审核的迭代请求

## 版本历史

### v1.0.0 (2024-01-15)
- 初始版本发布
- 实现完整的自我迭代框架
- 支持代码读取、写入、校验、差异对比和部署
- 包含完整的安全审核机制

## 许可证

GPL-3.0-or-later

## 作者

MaiBot开发者

## 反馈与支持

如有问题或建议，欢迎提交Issue或联系开发团队。
